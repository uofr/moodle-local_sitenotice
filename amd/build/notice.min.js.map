{"version":3,"file":"notice.min.js","sources":["../src/notice.js"],"sourcesContent":["/**\n * User interaction with notice\n * @author     Nathan Nguyen <nathannguyen@catalyst-au.net>\n * @copyright  Catalyst IT\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(\n    ['jquery', 'core/ajax', 'local_sitenotice/modal_notice'],\n    function ($, ajax, ModalNotice) {\n\n        var notices = {};\n        var modal;\n        var viewednotices = [];\n\n        var SiteNotice = {};\n\n        /**\n         * Retrieved notice which has not been viewwed.\n         * @returns {boolean|*}\n         */\n        var getNotice = function() {\n            for (var i in notices) {\n                // Check the notice has been viewed.\n                if (!viewednotices.includes(i)) {\n                    viewednotices.push(i);\n                    return notices[i];\n                }\n            }\n            return false;\n        };\n\n        /**\n         * Show next notice in the modal.\n         */\n        var nextNotice = function () {\n            var nextnotice = getNotice();\n            if (nextnotice == false) {\n                return;\n            }\n            if (typeof modal === 'undefined') {\n                ModalNotice.create({\n                    title: nextnotice.title,\n                    body: nextnotice.content,\n                    large: true,\n                })\n                .then(function (newmodal) {\n                    modal = newmodal;\n\n                    modal.setNoticeId(nextnotice.id);\n                    modal.setRequiredAcknowledgement(nextnotice.reqack);\n\n                    // Event listener for close button.\n                    modal.getModal().on('click', modal.getCloseButtonID(), function() {\n                        dismissNotice();\n                        modal.hide();\n                    });\n                    // Event listener for accept button.\n                    modal.getModal().on('click', modal.getAcceptButtonID(), function() {\n                        acknowledgeNotice();\n                        modal.hide();\n                    });\n                    // Event listener for link tracking.\n                    modal.getModal().on('click', 'a', function() {\n                        var linkid = $(this).attr(\"data-linkid\");\n                        trackLink(linkid);\n                    });\n                    // Event listener for ack checkbox.\n                    modal.getModal().on('click', modal.getAckCheckboxID(), function() {\n                        var ischecked = $(modal.getAckCheckboxID()).is(\":checked\");\n                        $(modal.getAcceptButtonID()).attr('disabled', !ischecked);\n                        if (!ischecked) {\n                            modal.turnonToolTip();\n                        } else {\n                            modal.turnoffToolTip();\n                        }\n                    });\n\n                    modal.show();\n                    modal.getModal().focus();\n                });\n            } else {\n                // Update with new details.\n                modal.setTitle(nextnotice.title);\n                modal.setBody(nextnotice.content);\n                modal.setNoticeId(nextnotice.id);\n                modal.setRequiredAcknowledgement(nextnotice.reqack);\n                modal.show();\n                modal.getModal().focus();\n            }\n        };\n\n        /**\n         * Dismiss Notice.\n         */\n        var dismissNotice = function () {\n            var noticeid = modal.getNoticeId();\n            var promises = ajax.call([\n                { methodname: 'local_sitenotice_dismiss', args: { noticeid: noticeid} }\n            ]);\n\n            promises[0].done(function(response) {\n                if(response.redirecturl) {\n                    window.open(response.redirecturl,\"_parent\", \"\");\n                } else {\n                    nextNotice();\n                }\n            }).fail(function(ex) {\n                // TODO: Log fail event.\n                this.console.log(ex);\n            });\n        };\n\n        /**\n         * Acknowledge notice.\n         */\n        var acknowledgeNotice = function () {\n            var noticeid = modal.getNoticeId();\n            var promises = ajax.call([\n                { methodname: 'local_sitenotice_acknowledge', args: { noticeid: noticeid} }\n            ]);\n\n            promises[0].done(function(response) {\n                if(response.redirecturl) {\n                    window.open(response.redirecturl,\"_parent\", \"\");\n                } else {\n                    nextNotice();\n                }\n            }).fail(function(ex) {\n                // TODO: Log fail event.\n                this.console.log(ex);\n            });\n        };\n\n        /**\n         * Link tracking.\n         * @param {Integer} linkid\n         */\n        var trackLink = function (linkid) {\n            var promises = ajax.call([\n                { methodname: 'local_sitenotice_tracklink', args: {linkid: linkid} }\n            ]);\n\n            promises[0].done(function(response) {\n                if(response.redirecturl) {\n                    window.open(response.redirecturl,\"_parent\", \"\");\n                }\n            }).fail(function(ex) {\n                this.console.log(ex);\n            });\n        };\n\n        /**\n         * Initial Modal with user notices.\n         */\n        SiteNotice.init = function() {\n            var promises = ajax.call([\n                { methodname: 'local_sitenotice_getnotices', args: {} }\n            ]);\n\n            promises[0].done(function(response) {\n                notices = JSON.parse(response.notices);\n                $(document).ready(function() {\n                    nextNotice();\n                });\n            }).fail(function(ex) {\n                this.console.log(ex);\n            });\n        };\n\n        return SiteNotice;\n    }\n);"],"names":["define","$","ajax","ModalNotice","modal","notices","viewednotices","SiteNotice","nextNotice","nextnotice","i","includes","push","getNotice","create","title","body","content","large","then","newmodal","setNoticeId","id","setRequiredAcknowledgement","reqack","getModal","on","getCloseButtonID","dismissNotice","hide","getAcceptButtonID","acknowledgeNotice","linkid","this","attr","trackLink","getAckCheckboxID","ischecked","is","turnoffToolTip","turnonToolTip","show","focus","setTitle","setBody","noticeid","getNoticeId","call","methodname","args","done","response","redirecturl","window","open","fail","ex","console","log","init","JSON","parse","document","ready"],"mappings":";;;;;;AAOAA,iCACI,CAAC,SAAU,YAAa,kCACxB,SAAUC,EAAGC,KAAMC,iBAGXC,MADAC,QAAU,GAEVC,cAAgB,GAEhBC,WAAa,GAoBbC,WAAa,eACTC,WAfQ,eACP,IAAIC,KAAKL,YAELC,cAAcK,SAASD,UACxBJ,cAAcM,KAAKF,GACZL,QAAQK,UAGhB,EAOUG,GACC,GAAdJ,kBAGiB,IAAVL,MACPD,YAAYW,OAAO,CACfC,MAAON,WAAWM,MAClBC,KAAMP,WAAWQ,QACjBC,OAAO,IAEVC,MAAK,SAAUC,WACZhB,MAAQgB,UAEFC,YAAYZ,WAAWa,IAC7BlB,MAAMmB,2BAA2Bd,WAAWe,QAG5CpB,MAAMqB,WAAWC,GAAG,QAAStB,MAAMuB,oBAAoB,WACnDC,gBACAxB,MAAMyB,UAGVzB,MAAMqB,WAAWC,GAAG,QAAStB,MAAM0B,qBAAqB,WACpDC,oBACA3B,MAAMyB,UAGVzB,MAAMqB,WAAWC,GAAG,QAAS,KAAK,eAC1BM,OAAS/B,EAAEgC,MAAMC,KAAK,eAC1BC,UAAUH,WAGd5B,MAAMqB,WAAWC,GAAG,QAAStB,MAAMgC,oBAAoB,eAC/CC,UAAYpC,EAAEG,MAAMgC,oBAAoBE,GAAG,YAC/CrC,EAAEG,MAAM0B,qBAAqBI,KAAK,YAAaG,WAC1CA,UAGDjC,MAAMmC,iBAFNnC,MAAMoC,mBAMdpC,MAAMqC,OACNrC,MAAMqB,WAAWiB,YAIrBtC,MAAMuC,SAASlC,WAAWM,OAC1BX,MAAMwC,QAAQnC,WAAWQ,SACzBb,MAAMiB,YAAYZ,WAAWa,IAC7BlB,MAAMmB,2BAA2Bd,WAAWe,QAC5CpB,MAAMqC,OACNrC,MAAMqB,WAAWiB,WAOrBd,cAAgB,eACZiB,SAAWzC,MAAM0C,cACN5C,KAAK6C,KAAK,CACrB,CAAEC,WAAY,2BAA4BC,KAAM,CAAEJ,SAAUA,aAGvD,GAAGK,MAAK,SAASC,UACnBA,SAASC,YACRC,OAAOC,KAAKH,SAASC,YAAY,UAAW,IAE5C5C,gBAEL+C,MAAK,SAASC,SAERC,QAAQC,IAAIF,QAOrBzB,kBAAoB,eAChBc,SAAWzC,MAAM0C,cACN5C,KAAK6C,KAAK,CACrB,CAAEC,WAAY,+BAAgCC,KAAM,CAAEJ,SAAUA,aAG3D,GAAGK,MAAK,SAASC,UACnBA,SAASC,YACRC,OAAOC,KAAKH,SAASC,YAAY,UAAW,IAE5C5C,gBAEL+C,MAAK,SAASC,SAERC,QAAQC,IAAIF,QAQrBrB,UAAY,SAAUH,QACP9B,KAAK6C,KAAK,CACrB,CAAEC,WAAY,6BAA8BC,KAAM,CAACjB,OAAQA,WAGtD,GAAGkB,MAAK,SAASC,UACnBA,SAASC,aACRC,OAAOC,KAAKH,SAASC,YAAY,UAAW,OAEjDG,MAAK,SAASC,SACRC,QAAQC,IAAIF,eAOzBjD,WAAWoD,KAAO,WACCzD,KAAK6C,KAAK,CACrB,CAAEC,WAAY,8BAA+BC,KAAM,MAG9C,GAAGC,MAAK,SAASC,UACtB9C,QAAUuD,KAAKC,MAAMV,SAAS9C,SAC9BJ,EAAE6D,UAAUC,OAAM,WACdvD,mBAEL+C,MAAK,SAASC,SACRC,QAAQC,IAAIF,QAIlBjD"}